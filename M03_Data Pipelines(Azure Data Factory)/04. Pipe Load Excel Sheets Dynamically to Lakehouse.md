## üìÅ Pipeline 2: Load Excel Sheets Dynamically to Lakehouse

### ‚úÖ Use Case

When you **don't know the sheet names/count** in advance, this pipeline dynamically detects the number of sheets and loads all of them.

---

### üß≠ Navigation Steps

1. Go to **Microsoft Fabric > Data Engineering**
2. Create a new **Data Pipeline**
3. Rename it: `Dynamic_Excel_Sheet_Load_To_Lakehouse`
4. Add the following activities:
   - `GetMetadata` (for invalid sheet index)
   - `SetVariable` (capture error)
   - `SetVariable` (generate index array)
   - `ForEach` (loop through indexes and copy)

---

### üßÆ Variables

| Name                  | Type   | Description                             |
|-----------------------|--------|-----------------------------------------|
| `excelSheetErrorMessage` | String | Stores error from invalid sheet access  |
| `sheetIndexArray`        | Array  | Holds indexes like `[0, 1, 2, ..., n]`  |

---

### üîπ Activity: `getMetadata_InvalidSheet`

- **Type**: `GetMetadata`
- **Purpose**: Access sheet index `999` to trigger an error.
- **Extracts**: Total number of sheets from error message.

---

### üîπ Activity: `setExcelErrorMessage`

- **Type**: `SetVariable`
- **Expression**:
  ```expression
  @split(activity('getMetadata_InvalidSheet').error.message,'(')[2]
  ```

---

### üîπ Activity: `generateSheetIndexArray`

- **Type**: `SetVariable`
- **Expression**:
  ```expression
  @range(
    0,
    add(
      int(
        substring(
          variables('excelSheetErrorMessage'),
          3,
          sub(
            length(variables('excelSheetErrorMessage')),
            4
          )
        )
      ),
      1
    )
  )
  ```

---

### üîÅ Activity: `loopThroughSheets`

- **Type**: `ForEach`
- **Items**: `@variables('sheetIndexArray')`
- **Inside Loop**: `copySheetDataToLakehouse`

---

### üîπ Activity: `copySheetDataToLakehouse`

- **Type**: `Copy`
- **Source**:
  - **Sheet Index**: `@item()` (0-based)
- **Sink**:
  - **Table**: `emp202504111`
  - **Action**: `Append`

---

### Json
<details>
<summary>Click to expand the JSON</summary>

``` json
{
    "name": "pipeline39_parameter_foreach_v1",
    "objectId": "a1131d64-65ab-4a5c-af75-9608287a023e",
    "properties": {
        "activities": [
            {
                "name": "Copy data1",
                "type": "Copy",
                "dependsOn": [],
                "policy": {
                    "timeout": "0.12:00:00",
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "typeProperties": {
                    "source": {
                        "type": "BinarySource",
                        "storeSettings": {
                            "type": "HttpReadSettings",
                            "requestMethod": "GET"
                        },
                        "formatSettings": {
                            "type": "BinaryReadSettings"
                        },
                        "datasetSettings": {
                            "annotations": [],
                            "type": "Binary",
                            "typeProperties": {
                                "location": {
                                    "type": "HttpServerLocation"
                                }
                            },
                            "externalReferences": {
                                "connection": "59eb3c17-281f-46ad-842f-1f985923588c"
                            }
                        }
                    },
                    "sink": {
                        "type": "BinarySink",
                        "storeSettings": {
                            "type": "LakehouseWriteSettings"
                        },
                        "datasetSettings": {
                            "annotations": [],
                            "connectionSettings": {
                                "name": "b2026_lakehouse",
                                "properties": {
                                    "annotations": [],
                                    "type": "Lakehouse",
                                    "typeProperties": {
                                        "workspaceId": "55732739-60eb-445b-94c4-65725b7190fa",
                                        "artifactId": "a375dc6e-2dd7-4a0c-a829-7e6bc66cb0a3",
                                        "rootFolder": "Files"
                                    },
                                    "externalReferences": {
                                        "connection": "f0fb8c6b-1fe2-4f0c-803b-425bb27465b7"
                                    }
                                }
                            },
                            "type": "Binary",
                            "typeProperties": {
                                "location": {
                                    "type": "LakehouseLocation",
                                    "fileName": "Load_multiple_sheets_of_excel.xlsx",
                                    "folderPath": "bronze"
                                }
                            }
                        }
                    },
                    "enableStaging": false
                }
            },
            {
                "name": "ForEach1_loop_parameters",
                "type": "ForEach",
                "dependsOn": [
                    {
                        "activity": "getIndexNumbers",
                        "dependencyConditions": [
                            "Succeeded"
                        ]
                    }
                ],
                "typeProperties": {
                    "items": {
                        "value": "@variables('vGetIndexNumbers')",
                        "type": "Expression"
                    },
                    "isSequential": true,
                    "activities": [
                        {
                            "name": "Set variable1",
                            "type": "SetVariable",
                            "dependsOn": [],
                            "policy": {
                                "secureOutput": false,
                                "secureInput": false
                            },
                            "typeProperties": {
                                "variableName": "test",
                                "value": {
                                    "value": "@item()",
                                    "type": "Expression"
                                }
                            }
                        },
                        {
                            "name": "Copy data2",
                            "type": "Copy",
                            "dependsOn": [
                                {
                                    "activity": "Set variable1",
                                    "dependencyConditions": [
                                        "Succeeded"
                                    ]
                                }
                            ],
                            "policy": {
                                "timeout": "0.12:00:00",
                                "retry": 0,
                                "retryIntervalInSeconds": 30,
                                "secureOutput": false,
                                "secureInput": false
                            },
                            "typeProperties": {
                                "source": {
                                    "type": "ExcelSource",
                                    "storeSettings": {
                                        "type": "LakehouseReadSettings",
                                        "recursive": true,
                                        "enablePartitionDiscovery": false
                                    },
                                    "datasetSettings": {
                                        "annotations": [],
                                        "connectionSettings": {
                                            "name": "b2026_lakehouse",
                                            "properties": {
                                                "annotations": [],
                                                "type": "Lakehouse",
                                                "typeProperties": {
                                                    "workspaceId": "55732739-60eb-445b-94c4-65725b7190fa",
                                                    "artifactId": "a375dc6e-2dd7-4a0c-a829-7e6bc66cb0a3",
                                                    "rootFolder": "Files"
                                                },
                                                "externalReferences": {
                                                    "connection": "f0fb8c6b-1fe2-4f0c-803b-425bb27465b7"
                                                }
                                            }
                                        },
                                        "type": "Excel",
                                        "typeProperties": {
                                            "location": {
                                                "type": "LakehouseLocation",
                                                "fileName": "Load_multiple_sheets_of_excel.xlsx",
                                                "folderPath": "bronze"
                                            },
                                            "sheetIndex": {
                                                "value": "@item()",
                                                "type": "Expression"
                                            },
                                            "firstRowAsHeader": true
                                        },
                                        "schema": []
                                    }
                                },
                                "sink": {
                                    "type": "LakehouseTableSink",
                                    "tableActionOption": "Append",
                                    "partitionOption": "None",
                                    "applyVOrder": true,
                                    "datasetSettings": {
                                        "annotations": [],
                                        "connectionSettings": {
                                            "name": "b2026_lakehouse",
                                            "properties": {
                                                "annotations": [],
                                                "type": "Lakehouse",
                                                "typeProperties": {
                                                    "workspaceId": "55732739-60eb-445b-94c4-65725b7190fa",
                                                    "artifactId": "a375dc6e-2dd7-4a0c-a829-7e6bc66cb0a3",
                                                    "rootFolder": "Tables"
                                                },
                                                "externalReferences": {
                                                    "connection": "f0fb8c6b-1fe2-4f0c-803b-425bb27465b7"
                                                }
                                            }
                                        },
                                        "type": "LakehouseTable",
                                        "schema": [],
                                        "typeProperties": {
                                            "schema": "silver",
                                            "table": "emp_excel"
                                        }
                                    }
                                },
                                "enableStaging": false,
                                "translator": {
                                    "type": "TabularTranslator",
                                    "typeConversion": true,
                                    "typeConversionSettings": {
                                        "allowDataTruncation": true,
                                        "treatBooleanAsNumber": false
                                    }
                                }
                            }
                        }
                    ]
                }
            },
            {
                "name": "Get Metadata1",
                "type": "GetMetadata",
                "dependsOn": [
                    {
                        "activity": "Copy data1",
                        "dependencyConditions": [
                            "Succeeded"
                        ]
                    }
                ],
                "policy": {
                    "timeout": "0.12:00:00",
                    "retry": 0,
                    "retryIntervalInSeconds": 30,
                    "secureOutput": false,
                    "secureInput": false
                },
                "typeProperties": {
                    "fieldList": [
                        "columnCount",
                        "exists",
                        "itemName",
                        "itemType",
                        "lastModified",
                        "size",
                        "structure",
                        "contentMD5"
                    ],
                    "datasetSettings": {
                        "annotations": [],
                        "connectionSettings": {
                            "name": "b2026_lakehouse",
                            "properties": {
                                "annotations": [],
                                "type": "Lakehouse",
                                "typeProperties": {
                                    "workspaceId": "55732739-60eb-445b-94c4-65725b7190fa",
                                    "artifactId": "a375dc6e-2dd7-4a0c-a829-7e6bc66cb0a3",
                                    "rootFolder": "Files"
                                },
                                "externalReferences": {
                                    "connection": "f0fb8c6b-1fe2-4f0c-803b-425bb27465b7"
                                }
                            }
                        },
                        "type": "Excel",
                        "typeProperties": {
                            "location": {
                                "type": "LakehouseLocation",
                                "fileName": "Load_multiple_sheets_of_excel.xlsx",
                                "folderPath": "bronze"
                            },
                            "sheetIndex": 99
                        },
                        "schema": []
                    },
                    "storeSettings": {
                        "type": "AzureBlobStorageReadSettings",
                        "recursive": true,
                        "enablePartitionDiscovery": false
                    }
                }
            },
            {
                "name": "getErrorMsg",
                "type": "SetVariable",
                "dependsOn": [
                    {
                        "activity": "Get Metadata1",
                        "dependencyConditions": [
                            "Failed"
                        ]
                    }
                ],
                "policy": {
                    "secureOutput": false,
                    "secureInput": false
                },
                "typeProperties": {
                    "variableName": "vGetErrorMsg",
                    "value": {
                        "value": "@split(activity('Get Metadata1').error.message,'(')[2]",
                        "type": "Expression"
                    }
                }
            },
            {
                "name": "getIndexNumbers",
                "type": "SetVariable",
                "dependsOn": [
                    {
                        "activity": "getErrorMsg",
                        "dependencyConditions": [
                            "Succeeded"
                        ]
                    }
                ],
                "policy": {
                    "secureOutput": false,
                    "secureInput": false
                },
                "typeProperties": {
                    "variableName": "vGetIndexNumbers",
                    "value": {
                        "value": "@range(\n  0,\n  add(\n    int(\n      substring(\n        variables('vGetErrorMsg'),\n        3,\n        sub(\n          length(variables('vGetErrorMsg')),\n          4\n        )\n      )\n    ),\n    1\n  )\n)",
                        "type": "Expression"
                    }
                }
            }
        ],
        "variables": {
            "test": {
                "type": "Integer"
            },
            "vGetErrorMsg": {
                "type": "String"
            },
            "vGetIndexNumbers": {
                "type": "Array"
            }
        },
        "lastModifiedByObjectId": "07dffa9c-d10a-43aa-a4dc-89568542f3c3",
        "lastPublishTime": "2026-02-11T01:45:52Z"
    }
}
