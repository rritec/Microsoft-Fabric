# üìò Classroom Notes: Monitor File Arrival Using Until Loop in Microsoft Fabric

## üéØ Objective
This pipeline demonstrates how to:
- Use the **Until** activity to repeatedly check for a file in a Lakehouse folder.
- Retrieve file metadata using **Get Metadata** activity.
- Dynamically update a variable that controls the loop.
- Use **Wait** to pause between checks.

---
![image](https://github.com/user-attachments/assets/5803169a-49b9-4b66-8d5c-547dda925ee0)


## üß± Pipeline Name: `MonitorFileArrivalLoop`

---

## üìù Step-by-Step Navigation

### ü•á Step 1: Create a New Pipeline
1. Open **Microsoft Fabric** ‚Üí **Data Engineering** workspace.
2. Go to **Data Pipelines**.
3. Click **New Pipeline**.
4. Rename it to: `MonitorFileArrivalLoop`.

---

### üßÆ Step 2: Create a Pipeline Variable
1. Click on the **Variables** panel (on the right).
2. Add a new variable:
   - **Name**: `FileArrived`
   - **Type**: `Boolean`

---

#### üîÅ Step 3: Add an 'Until' Activity
1. From the **Activities** pane, drag the **Until** activity onto the canvas.
2. Rename it to: `Wait For File`.
3. In the **Settings** tab, set the **Exit Condition**:
   ```expression
   @variables('FileArrived')
   ```
4. Set a **timeout** if needed (e.g., `12 hours` ‚Üí `0.12:00:00`).

---

### üß© Inside the 'Until' Activity: Add Inner Activities

##### üîç A. Add 'Get Metadata' Activity
1. Drag a **Get Metadata** activity into the `Until` loop.
2. Rename it to: `Check File Exists`.
3. Configure the dataset settings:
   - **Linked Service**: Your Lakehouse (e.g., `rr_batch100`)
   - **File name**: `emphhhhhhh.csv`
   - **Folder path**: `rawdata`
   - **Field list**: `exists`
   - Ensure file format is **DelimitedText**
4. Use default read settings under `storeSettings` and `formatSettings`.

---

##### ‚úçÔ∏è B. Add 'Set Variable' Activity
1. Drag a **Set Variable** activity into the loop.
2. Rename it to: `Set FileArrived Flag`.
3. Connect it after `Check File Exists`.
4. In **Settings**:
   - **Variable name**: `FileArrived`
   - **Value (Expression)**:
     ```expression
     @activity('Check File Exists').output.exists
     ```

---

##### ‚è±Ô∏è C. Add 'Wait' Activity
1. Drag a **Wait** activity into the loop.
2. Rename it to: `Pause for 5 Seconds`.
3. Connect it after `Set FileArrived Flag`.
4. In **Settings**, set:
   - **Wait time**: `5` seconds

---

![image](https://github.com/user-attachments/assets/8d735655-96fe-4491-b082-a79582883c1b)

### üîÑ Final Loop Flow

| Activity Name         | Trigger Condition | Description                                           |
|----------------------|-------------------|-------------------------------------------------------|
| Wait For File         | Loop until true   | Loops until `FileArrived` becomes `true`             |
| Check File Exists     | Every iteration   | Checks if the file exists in Lakehouse               |
| Set FileArrived Flag  | After metadata    | Sets `FileArrived` based on `exists` property  


```json
{
    "name": "MonitorFileArrivalLoop",
    "objectId": "48efe194-c4fe-44c5-8c94-7241e0f0f6da",
    "properties": {
        "activities": [
            {
                "name": "Wait For File",
                "type": "Until",
                "dependsOn": [],
                "typeProperties": {
                    "expression": {
                        "value": "@variables('FileArrived')",
                        "type": "Expression"
                    },
                    "activities": [
                        {
                            "name": "Get Metadata1",
                            "type": "GetMetadata",
                            "dependsOn": [],
                            "policy": {
                                "timeout": "0.12:00:00",
                                "retry": 0,
                                "retryIntervalInSeconds": 30,
                                "secureOutput": false,
                                "secureInput": false
                            },
                            "typeProperties": {
                                "fieldList": [
                                    "exists"
                                ],
                                "datasetSettings": {
                                    "annotations": [],
                                    "connectionSettings": {
                                        "name": "b2026_lakehouse",
                                        "properties": {
                                            "annotations": [],
                                            "type": "Lakehouse",
                                            "typeProperties": {
                                                "workspaceId": "55732739-60eb-445b-94c4-65725b7190fa",
                                                "artifactId": "a375dc6e-2dd7-4a0c-a829-7e6bc66cb0a3",
                                                "rootFolder": "Files"
                                            },
                                            "externalReferences": {
                                                "connection": "df9c6fe2-f764-42d6-9eb5-ab163b8de723"
                                            }
                                        }
                                    },
                                    "type": "DelimitedText",
                                    "typeProperties": {
                                        "location": {
                                            "type": "LakehouseLocation",
                                            "fileName": "emp1.csv",
                                            "folderPath": "bronze"
                                        },
                                        "columnDelimiter": ",",
                                        "escapeChar": "\\",
                                        "firstRowAsHeader": true,
                                        "quoteChar": "\""
                                    },
                                    "schema": []
                                },
                                "storeSettings": {
                                    "type": "LakehouseReadSettings",
                                    "enablePartitionDiscovery": false
                                },
                                "formatSettings": {
                                    "type": "DelimitedTextReadSettings"
                                }
                            }
                        },
                        {
                            "name": "Set variable1",
                            "type": "SetVariable",
                            "dependsOn": [
                                {
                                    "activity": "Get Metadata1",
                                    "dependencyConditions": [
                                        "Succeeded"
                                    ]
                                }
                            ],
                            "policy": {
                                "secureOutput": false,
                                "secureInput": false
                            },
                            "typeProperties": {
                                "variableName": "FileArrived",
                                "value": {
                                    "value": "@activity('Get Metadata1').output.exists",
                                    "type": "Expression"
                                }
                            }
                        },
                        {
                            "name": "Wait1",
                            "type": "Wait",
                            "dependsOn": [
                                {
                                    "activity": "Set variable1",
                                    "dependencyConditions": [
                                        "Succeeded"
                                    ]
                                }
                            ],
                            "typeProperties": {
                                "waitTimeInSeconds": 5
                            }
                        }
                    ],
                    "timeout": "0.12:00:00"
                }
            }
        ],
        "variables": {
            "FileArrived": {
                "type": "Boolean"
            }
        },
        "lastModifiedByObjectId": "07dffa9c-d10a-43aa-a4dc-89568542f3c3",
        "lastPublishTime": "2026-02-19T04:04:41Z"
    }
}
```
